var pagePollInterval=1E3,processArguments=function(a){for(var b={},d=[],c,e=function(a,d){if(b.hasOwnProperty(a)){var e=b[a];e instanceof Array||(b[a]=[e]);b[a].push(d)}else b[a]=d;c=null},g=0;g<a.length;g++){var h=a[g],f=/--([\w_-]+)(?=\=(.*)|$)/.exec(h);f?(c&&e(c,!0),void 0!=f[2]?e(f[1],f[2]):c=f[1]):c?e(c,h):d.push(h)}c&&e(c,!0);return{options:b,argv:d}},constructURL=function(a,b){b=b||{};a.match(/^https?:\/\//)||(a="http://"+a);var d=!0,c;for(c in b)null!=b[c]&&(d=d?a.match(/\?/)?"&":"?":"&",
a+=d+c+"="+encodeURIComponent(b[c]),d=!1);return a},parseBrowser=function(a){var b="unknown",d="",c;if(c=/Firefox\/((?:\d+\.?)+)/.exec(a))b="Firefox",d=c[1];if(c=/Chrome\/((?:\d+\.?)+)/.exec(a))b="Chrome",d=c[1];if(c=/MSIE\s*((?:\d+\.?)+)/.exec(a))b="IE",d=c[1];a.match(/trident/i)&&(c=/rv.(\d\d\.?\d?)/.exec(a))&&(b="IE",d=c[1]);if(c=/Apple.*Version\/((?:\d+\.?)+)\s*(?=Safari\/((?:\d+\.?)+))/.exec(a))b="Safari",d=c[1]+" ("+c[2]+")";return{name:b,version:d}},parseOS=function(a){return/Win/.test(a)?
"Windows":/Mac/.test(a)?"MacOS":/Linux/.test(a)?"Linux":"unknown"},processCoverageOptions=function(a){var b=a["coverage-report-format"]||"";b instanceof Array||(b=[b]);b.forEach(function(a,b,c){a=a.split(/\+|,/);1!=a.length&&(c[b]=a)});b=Array.prototype.concat.apply([],b).filter(function(a){return Boolean(a)});b.forEach(function(a){"html"!=a&&("raw"!=a&&"lcov"!=a)&&(print("Unrecognized coverage report format: "+a),quit(6))});var d=a["coverage-report-dir"]||convertPath("./coverage/"),d=d.replace(/\/?$/,
""),c=0<b.length,e=a["coverage-unit"];e&&("file"!=e&&"extjs_class"!=e)&&(print("Unrecognized coverage unit: "+e),quit(6));if(a=a["previous-coverage-report"]){var g;try{g=readFile(a)}catch(h){try{g=readFile(a.replace(/(\\|\/)?$/,"/")+"raw_coverage_data.json")}catch(f){print("Can't read the content of the previous raw coverage report: "+f),quit(6)}}try{if(g=JSON.parse(g),!g.coverageUnit||!g.rawReport)throw"";}catch(k){print("Previous raw coverage report is not a valid JSON or has wrong format"),quit(6)}a=
g}return{enableCodeCoverage:c,coverageUnit:e,previousCoverageReport:a,coverageReportFormats:b,coverageReportDir:d}},pollStep=function(a,b){var d=a.executeScript("return Siesta.my.activeHarness.getPageState()");if(d)b.exceptionCounter=0;else return b.exceptionCounter?b.exceptionCounter++:b.exceptionCounter=1,{exitCode:2<=b.exceptionCounter?3:null};var c=d.commands;if(c)for(var e=0;e<c.length;e++){var g=c[e];a[g.name](g);a.executeScript("Siesta.my.activeHarness.onCommandDone("+g.id+")")}e=d.lastActivity;
b.lastActivityToken||(b.lastActivityToken=e,b.timeOfLastActivity=new Date,b.exceptionCounter=0);c={exitCode:d.exitCode};e==b.lastActivityToken?18E4<new Date-b.timeOfLastActivity&&(c.exitCode=2):(b.lastActivityToken=e,b.timeOfLastActivity=new Date);d=d.log;"__NULL__"!=d&&(c.log=d);return c},pollPage=function(a,b,d,c){c=c||{};do{var e=pollStep(a,c);e.hasOwnProperty("log")&&a.print(e.log);2==e.exitCode&&(a.print("TIMEOUT: 3 minutes of inactivity, continue to the next test"),a.executeScript("return Siesta.my.activeHarness.restartFromNextTest()")&&
(e.exitCode=null));null!=e.exitCode?a.sleep(pagePollInterval,function(){d(e.exitCode)}):a.sleep(pagePollInterval,function(){b||pollPage(a,b,d,c)})}while(null==e.exitCode&&b)},runPage=function(a,b,d){var c=b.currentPage,e=b.enableCodeCoverage,g=b.shared;a.setWindowSize(b.viewportWidth,b.viewportHeight);a.debug("Opening harness page: "+b.url);a.open(b.url,function(){a.debug("Page opened successfully: "+b.url);var h=a.executeScript("return Siesta.my.activeHarness.pageCount");a.debug("Page count: "+h+
", curent page: "+c);e&&g.contentManagerState&&a.executeScript("__CONTENT_MANAGER_STATE__ = "+JSON.stringify(g.contentManagerState));pollPage(a,b.sync,function(f){a.debug("Page completed with exit code: "+f);3==f&&a.print("ERROR: browser not reachable");var k={exitCode:f,pageCount:h};0==h?(a.close(),d(k)):(f=c==h-1,k.pageReport=a.executeScript("return Siesta.my.activeHarness.generateUnifiedPageReport({ asJSON : true })"),e&&(f||(g.contentManagerState=a.executeScript("return Siesta.my.activeHarness.getContentManagerState()")),
g.coverageInfo=a.executeScript("return Siesta.my.activeHarness.getRawTotalCoverageInfo(false,"+JSON.stringify(g.coverageInfo)+")")),f?d(k):(a.debug("Closing non-last page"),a.close(),a.sleep(b.pagePause||3E3,function(){d(k)})))})})},runBrowser=function(a,b,d){a.debug("Started browser session: "+a.browserName);var c=[],e=0,g=null,h=b.reportOptions,f=b.query,k=0,l=b.previousCoverageReport,p=l?{coverageInfo:l.rawReport,contentManagerState:l.contentManagerState}:{},m=function(){f.page=e;runPage(a,{url:constructURL(b.harnessURL,
f),viewportWidth:b.viewportWidth,viewportHeight:b.viewportHeight,currentPage:e,sync:b.sync,pagePause:b.pagePause,enableCodeCoverage:b.enableCodeCoverage,shared:p},function(f){e||(g=f.pageCount);k+=f.exitCode;if(g){var l=e==g-1;c.push(f.pageReport);if(l){f.summaryMessage?a.print(f.summaryMessage):a.print(a.executeScript("return Siesta.my.activeHarness.getAutomatedSummaryMessage("+JSON.stringify(c)+")"));h&&(f.combinedReport?a.saveReport(f.combinedReport):(h.pageReports=c,a.saveReport(a.executeScript("return Siesta.my.activeHarness.generateReport("+
JSON.stringify(h)+")"))));if(b.enableCodeCoverage){var n=b.coverageReportDir;b.coverageReportFormats.forEach(function(b){switch(b){case "html":a.saveHtmlCoverageReport(n,f.htmlReport||a.executeScript("return Siesta.my.activeHarness.generateCoverageHtmlReport()"));break;case "lcov":a.saveLcovCoverageReport(n,f.lcovReport||a.executeScript("return Siesta.my.activeHarness.generateCoverageLcovReport()"));break;case "raw":a.saveRawCoverageReport(n,f.rawReport||a.executeScript("return Siesta.my.activeHarness.generateCoverageRawReport()"))}})}a.debug("Closing last page");
a.close();d&&d(k)}else e++,b.sync||m()}else d&&d()})};m();if(b.sync)for(l=2;l<=g;l++)m()};
